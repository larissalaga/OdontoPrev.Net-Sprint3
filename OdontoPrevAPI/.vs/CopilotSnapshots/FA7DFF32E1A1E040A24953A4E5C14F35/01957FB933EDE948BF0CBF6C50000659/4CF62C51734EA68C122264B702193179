using Microsoft.AspNetCore.Mvc;
using OdontoPrevAPI.Repositories.Interfaces;
using OdontoPrevAPI.Tools;
using System.Threading.Tasks;
using Swashbuckle.AspNetCore.Annotations;
using Microsoft.EntityFrameworkCore;
using OdontoPrevAPI.Data;
using System.Collections.Generic;

namespace OdontoPrevAPI.Controllers
{
    /// <summary>
    /// Controlador para gerenciar dados de teste.
    /// </summary>
    [Route("api/[controller]")]
    [ApiController]
    public class TesteController : ControllerBase
    {
        private readonly IPacienteRepository _pacienteRepository;
        private readonly IDentistaRepository _dentistaRepository;
        private readonly IPlanoRepository _planoRepository;
        private readonly DataContext _context;

        /// <summary>
        /// Inicializa uma nova instância da classe <see cref="TesteController"/>.
        /// </summary>
        /// <param name="pacienteRepository">O repositório para entidades Paciente.</param>
        /// <param name="dentistaRepository">O repositório para entidades Dentista.</param>
        /// <param name="planoRepository">O repositório para entidades Plano.</param>
        /// <param name="context">O contexto de dados da aplicação.</param>
        public TesteController(
            IPacienteRepository pacienteRepository,
            IDentistaRepository dentistaRepository,
            IPlanoRepository planoRepository,
            DataContext context)
        {
            _pacienteRepository = pacienteRepository;
            _dentistaRepository = dentistaRepository;
            _planoRepository = planoRepository;
            _context = context;
        }

        /// <summary>
        /// Insere dados de teste no banco de dados.
        /// </summary>
        /// <returns>Resultado da operação de inserção de dados de teste.</returns>
        [HttpPost("populate")]
        [SwaggerOperation(Summary = "Popula o banco de dados com dados de teste", 
            Description = "Insere planos, dentistas e pacientes utilizando os dados pré-definidos em DadosDeTestes.")]
        [SwaggerResponse(200, "Dados de teste inseridos com sucesso")]
        [SwaggerResponse(500, "Erro interno")]
        public async Task<IActionResult> PopulateTestData()
        {
            try
            {
                // Contador para registrar quantas entidades foram inseridas
                int planosInseridos = 0;
                int dentistasInseridos = 0;
                int pacientesInseridos = 0;
                
                // 1. Insere todos os planos
                foreach (var plano in DadosDeTestes.ListaPlanos)
                {
                    try
                    {
                        await _planoRepository.Create(plano);
                        planosInseridos++;
                    }
                    catch (System.Exception ex)
                    {
                        // Registra, mas continua
                        System.Console.WriteLine($"Erro ao inserir plano {plano.DsCodigoPlano}: {ex.Message}");
                    }
                }

                // 2. Insere todos os dentistas
                foreach (var dentista in DadosDeTestes.ListaDentistas)
                {
                    try
                    {
                        await _dentistaRepository.Create(dentista);
                        dentistasInseridos++;
                    }
                    catch (System.Exception ex)
                    {
                        // Registra, mas continua
                        System.Console.WriteLine($"Erro ao inserir dentista {dentista.DsCro}: {ex.Message}");
                    }
                }

                // 3. Insere todos os pacientes
                foreach (var paciente in DadosDeTestes.ListaPacientes)
                {
                    try
                    {
                        await _pacienteRepository.Create(paciente);
                        pacientesInseridos++;
                    }
                    catch (System.Exception ex)
                    {
                        // Registra, mas continua
                        System.Console.WriteLine($"Erro ao inserir paciente {paciente.NrCpf}: {ex.Message}");
                    }
                }

                // Retorna um resumo das inserções
                return Ok(new
                {
                    message = "Dados de teste inseridos com sucesso",
                    details = new
                    {
                        planos = $"{planosInseridos} de {DadosDeTestes.ListaPlanos.Count} planos inseridos",
                        dentistas = $"{dentistasInseridos} de {DadosDeTestes.ListaDentistas.Count} dentistas inseridos",
                        pacientes = $"{pacientesInseridos} de {DadosDeTestes.ListaPacientes.Count} pacientes inseridos"
                    }
                });
            }
            catch (System.Exception ex)
            {
                return StatusCode(500, $"Erro ao inserir dados de teste: {ex.Message}");
            }
        }

        /// <summary>
        /// Limpa todos os dados do banco de dados.
        /// </summary>
        /// <returns>Resultado da operação de limpeza do banco de dados.</returns>
        [HttpDelete("clear")]
        [SwaggerOperation(Summary = "Limpa o banco de dados", 
            Description = "Remove todas as entidades Paciente, Dentista e Plano do banco de dados.")]
        [SwaggerResponse(200, "Banco de dados limpo com sucesso")]
        [SwaggerResponse(500, "Erro interno")]
        public async Task<IActionResult> ClearDatabase()
        {
            try
            {
                // Contadores para registrar quantas entidades foram removidas
                int pacientesRemovidos = 0;
                int dentistasRemovidos = 0;
                int planosRemovidos = 0;

                // 1. Obter todos os pacientes e removê-los primeiro (devido às restrições de chave estrangeira)
                var pacientes = await _pacienteRepository.GetAll();
                
                foreach (var paciente in pacientes)
                {
                    try
                    {
                        var result = await _pacienteRepository.DeleteById(paciente.IdPaciente);
                        if (result)
                            pacientesRemovidos++;
                    }
                    catch (System.Exception ex)
                    {
                        // Registra, mas continua para o próximo
                        System.Console.WriteLine($"Erro ao remover paciente ID {paciente.IdPaciente}: {ex.Message}");
                    }
                }

                // 2. Obter todos os dentistas e removê-los
                var dentistas = await _dentistaRepository.GetAll();
                
                foreach (var dentista in dentistas)
                {
                    try
                    {
                        var result = await _dentistaRepository.DeleteById(dentista.IdDentista);
                        if (result)
                            dentistasRemovidos++;
                    }
                    catch (System.Exception ex)
                    {
                        // Registra, mas continua para o próximo
                        System.Console.WriteLine($"Erro ao remover dentista ID {dentista.IdDentista}: {ex.Message}");
                    }
                }

                // 3. Obter todos os planos e removê-los por último (depois que todas as referências foram removidas)
                var planos = await _planoRepository.GetAll();
                
                foreach (var plano in planos)
                {
                    try
                    {
                        var result = await _planoRepository.DeleteById(plano.IdPlano);
                        if (result)
                            planosRemovidos++;
                    }
                    catch (System.Exception ex)
                    {
                        // Registra, mas continua para o próximo
                        System.Console.WriteLine($"Erro ao remover plano ID {plano.IdPlano}: {ex.Message}");
                    }
                }

                // Retorna um resumo das remoções
                return Ok(new
                {
                    message = "Banco de dados limpo com sucesso",
                    details = new
                    {
                        pacientes = $"{pacientesRemovidos} pacientes removidos",
                        dentistas = $"{dentistasRemovidos} dentistas removidos",
                        planos = $"{planosRemovidos} planos removidos"
                    }
                });
            }
            catch (System.Exception ex)
            {
                return StatusCode(500, $"Erro ao limpar o banco de dados: {ex.Message}");
            }
        }
    }
}

